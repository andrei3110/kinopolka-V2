<%- include('../particles/header.ejs') %>

    <div class="content__description">
        <div class="header__image">
            <div class="gradient"><img class="fone__image" src="/img/человекПаук.jpg"></div>
        </div>

        <div class="description__film" id="films">
            <div class="description__film__wrapper">
                <input type="hidden" name="nameId" value="<%= items.name %>">
                <img class="description__image" src="/img/<%= items.image %>">
                <h2 class="description__name" id="name">
                    <%= items.name %>
                </h2>
                <span class="about__film">О фильме:</span>
                <div class="description__information">
                    <div class="description__genre" id="genre">
                        <div class="title__text">Жанр:</div><span class="textViews" id="textViews">
                            <%= items.genre %>
                        </span>
                    </div>
                    <div class="description__country" id="country">
                        <div class="title__text">Страна: </div> <span class="textViews" id="textViews">
                            <%= items.country %>
                        </span>
                    </div>


                    <div class="description__year">
                        <div class="title__text">год:</div> <span class="textViews" id="textViews">
                            <%= items.year %>
                        </span>
                    </div>
                </div>
                <div class="role">
                    <div class="role--hidden__title">В главных ролях:</div>
                    <div class="description__producer" id="producer">
                        <div class="title__text">продюсер:</div> <span class="textViews" id="textViews">
                            <%= items.producer %>
                        </span>
                    </div>
                    <div class="description__actor" id="actor">
                        <div class="title__text">в главных ролях:</div>
                        <span class="textViews" id="textViews">
                            <%= items.actor %>
                        </span>
                    </div>
                    <div class="description__screenwriter" id="screenwriter">
                        <div class="title__text">сценарист:</div> <span class="textViews " id="textViews">
                            <%= items.screenwriter %>
                        </span>
                    </div>
                    <div class="description__operator" id="operator">
                        <div class="title__text">оператор:</div> <span class="textViews" id="textViews">
                            <%= items.operator%>
                        </span>
                    </div>
                    <div class="description__regicer" id="regicer">
                        <div class="title__text">режиссер:</div> <span class="textViews" id="textViews">
                            <%= items.regicer %>
                        </span>
                    </div>

                </div>
                <a href="#" class="description__AddToCart"><%- include('../icons/bookmark__icon.ejs') %></a>


                <div class="description__description" id="description">
                    <div class="title__text">описание:</div>
                    <p>
                        <%= items.description %>
                    </p>

                </div>

                <div class="averange" id="averange">
                    <% if (number>= 4.5) { %>
                        <font size="5" class="rate__name">рейтинг:</font>

                        <div class="rate__count five">
                            <span class="averangeText" id="averangeText">
                                <%= number %>
                            </span>

                        </div>

                        <% } else if(number>= 3.5) { %>
                            <font size="5" class="rate__name">рейтинг:</font>

                            <div class="rate__count four">
                                <span class="averangeText" id="averangeText">
                                    <%= number %>
                                </span>

                            </div>
                            <% } else if( number>= 2 ) { %>
                                <font size="5" class="rate__name">рейтинг:</font>

                                <div class="rate__count three">
                                    <span class="averangeText" id="averangeText">
                                        <%= number %>
                                    </span>

                                </div>
                                <% } else { %>
                                    <font size="5" class="rate__name">рейтинг:</font>

                                    <div class="rate__count two">
                                        <span class="averangeText" id="averangeText">
                                            <%= number %>
                                        </span>

                                    </div>
                                    <% } %>
                                        <div class="voices" id="voices">
                                            всего голосов:<span class="textVoises" id="textViews">
                                                <%= voices %>
                                            </span></div>
                </div>


                <% if (items.status=="бесплатно" ) { %>
                    <!-- FREE -->
                    <% } else { %>
                        <!-- SUBSCRIBE -->
                        <% } %>

            </div>
            <div>

                <!-- <iframe class="video" width="560" height="315" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe> -->
            </div>

            <div class="ratingForm" id="rating-wrapper">

                <form action="/rating/<%= items.id %>" method="post" id="rate-form">

                    <!-- <input type="hidden" name="item__name" value="<%= items.name %>"> -->


                    <% if (auth) { %>

                        <div class="container" id="container">
                            <div class="post">
                                <div class="text">Thanks for rating us !</div>
                                <div class="edit">EDIT</div>
                            </div>
                            <div class="star-widget">
                                <% for (let i=5; i> 0; i--) { %>
                                    <input type="radio" name="rate" id="rate-<%= i %>" value="<%= i %>">
                                    <label for="rate-<%= i %>" class="star__icon"><%- include('../icons/star__icon.ejs')
                                            %></label>
                                    <% } %>


                                        <div>

                                            <div class="textarea">
                                                <textarea cols="30" placeholder="Describe your  experense..."
                                                    type="text" name="text" required></textarea>
                                            </div>
                                            <div class="Btn">
                                                <p onclick="createRate()" id="button">Post</p>
                                            </div>
                                        </div>

                            </div>
                        </div>

                        <% if (mark) { %>
                            <script>
                                const post = document.querySelector(".post")
                                const widget = document.querySelector(".star-widget")


                                i == true;
                                widget.style.display = "block";
                                post.style.display = "none";
                            </script>
                            <% } else { %>
                                <script>
                                    const button = document.getElementById("button")
                                    const post = document.querySelector(".post")
                                    const widget = document.querySelector(".star-widget")
                                    const editBtn = document.querySelector(".edit")
                                    let i = true;


                                    widget.style.display = "none";
                                    post.style.display = "block";

                                    button.addEventListener("click", () => {
                                        widget.style.display = "none";
                                        post.style.display = "block";
                                        i = false;
                                        return false;
                                    })
                                </script>

                                <% } %>
                                    <% } %>
                </form>
            </div>
            <script>
                async function createRate() {
                    const post = document.querySelector(".post")
                    const widget = document.querySelector(".star-widget")
                    let ratingWrapper = document.querySelector('#rating-wrapper');
                    let RateForm = document.querySelector('#rate-form');

                    let rateFormData = new FormData(RateForm);
                    // ratingWrapper.innerHTML = '';
                    widget.style.display = "none";
                    post.style.display = "block";

                    await fetch(RateForm.action, {
                        'method': 'POST',
                        'body': JSON.stringify({
                            'rate': rateFormData.get('rate'),
                            'text': rateFormData.get('text'),

                        }),
                        'headers': {
                            'Content-Type': 'application/json',
                        }
                    })



                }


            </script>

            <div class="comment" id="comment">

                <div class="commentName">Комментарии:</div>

                <div class="comment__wrapper" id="comment-wrapper">
                    
                </div>
            </div>
        </div>
    </div>                         

    <script>
        async function getCommentAndShow() {
            let commentWrapper = document.querySelector('#comment-wrapper');


            let response = await fetch('/api/v1/comments/<%= items.id %>/show');

            let comments = await response.json();
           
            comments[1].forEach(comment => {
                commentWrapper.innerHTML += `<div class="comment__box">
                    <div name="userName" class="commentUsername">${comment.user__name}</div>
                    <div name="text" class="commentText">${comment.text}</div>
                </div> 
                <% if (auth) { %>
                        <% if (items.name == name || admin) { %>
                    <form action="/delete/comment/${comment.id}" method="post">
                        <input type="hidden" name="commentId" value=" ${comment.id}">
                        <input type="hidden" name="itemsID" value="<%= items.id %>">
                        <input type="hidden" name="commentName" value=" ${comment.user__name}">
                        <input class="deleteComment" type="submit" value="del">
                    </form>
                    <% } %>
                <% } %>
                `;
            });
        }

        getCommentAndShow();
    </script>



    <%- include('../particles/footer.ejs') %>